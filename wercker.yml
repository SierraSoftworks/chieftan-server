box: node:6

services:
    - mongo

build:
  steps:
    - script:
        name: echo nodejs information
        code: |
          echo "node version $(node -v) running"
          echo "npm version $(npm -v) running"
    - npm-install
    - script:
        name: build
        code: npm run build

test:
  steps:
    - npm-test

deploy-build:
  steps:
    - internal/docker-push:
        username: $USERNAME
        password: $PASSWORD
        registry: https://$REGISTRY
        repository: $REGISTRY/$REGISTRY_NAMESPACE/$WERCKER_GIT_REPOSITORY
        author: $WERCKER_STARTED_BY
        labels: VERSION=$WERCKER_GIT_COMMIT
        entrypoint: "npm run"
        cmd: "start"
        working-dir: "$WERCKER_SOURCE_DIR"
        env: "CHIEFTAN_MONGODB=mongodb://mongodb/chieftan"
        ports: "3000"

  after-steps:
    - slack-notifier:
        url: $SLACK_URL
        channel: builds
        username: wercker

deploy-release:
  steps:
    - internal/docker-push:
        username: $USERNAME
        password: $PASSWORD
        registry: https://$REGISTRY
        repository: $REGISTRY/$REGISTRY_NAMESPACE/$WERCKER_GIT_REPOSITORY
        tag: latest
        author: $WERCKER_STARTED_BY
        labels: VERSION=$WERCKER_GIT_COMMIT
        entrypoint: "npm run"
        cmd: "start"
        working-dir: "$WERCKER_SOURCE_DIR"
        env: "CHIEFTAN_MONGODB=mongodb://mongodb/chieftan"
        ports: "3000"

  after-steps:
    - slack-notifier:
        url: $SLACK_URL
        channel: builds
        username: wercker